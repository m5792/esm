
<style>
/* ===== PAGE WRAPPER ===== */
.page-wrapper {
    background-color: rgb(247, 249, 249);
    color: #004d80;
    font-weight: bold;
    border: 10px solid rgb(2, 45, 77);
    width: 10in;
    height: 18in;
    box-sizing: border-box;
    margin: 30px auto;        /* top-bottom + center horizontally * 10-18/
    padding: 30px;            /* inner spacing from border */
}

/* ===== FORM CONTAINER ===== */
.form-container {
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
    background-color: #f5fafc;
    padding: 20px 30px;       /* left-right + top spacing */
}

/* ===== HEADING CENTER ===== */
.form-container h2 {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 25px;
}

/* ===== LABELS ===== */
.form-container label {
    display: block;
    margin-bottom: 6px;
    font-weight: bold;
}

/* ===== INPUTS & SELECTS ===== */
.form-container input,
.form-container select {
    width: 100%;
    padding: 8px;
    margin-bottom: 16px;
    border: 2px solid #d6d7d8;
    border-radius: 6px;
    font-size: 16px;
    box-sizing: border-box;
    background-color: #f9f9f9;
}

/* ===== BUTTONS ===== */
.form-container input[type="submit"],
.form-container input[type="button"],
.form-container button {
    background-color: #080808;
    color: #f6f6f8;

    font-weight: bold;
    border: none;
    cursor: pointer;

    padding: 10px;
    border-radius: 6px;

    transition: background-color 0.3s ease, transform 0.2s ease;
}

.form-container input[type="submit"]:hover,
.form-container input[type="button"]:hover,
.form-container button:hover {
    background-color: #575555;
    transform: translateY(-2px);
}

#search5792Bar {
    background-color: #424242;
    width: 100%;
    display: flex;
    align-items: center;
    padding: 10px;
    flex-wrap: wrap;
    gap: 10px;
    box-sizing: border-box;
  }

  #search5792Input {
    flex: 1;
    background-color: #fdfdf6;
    border: none;
    padding: 6px 10px;
    border-radius: 4px;
    font-size: 14px;
    outline: none;
  }

  #search5792Bar label { font-weight: bold; color: rgb(247, 244, 244); margin-left: 10px;}
  #search5792Bar input[type="date"] { padding: 4px 60px; border-radius: 4px;border: 1px solid #ccc; font-size: 14px;}

/* Table Styling */
/* Container to control table width and responsiveness */
.table-container {
  width: 100%;
  overflow-x: auto;
}

 
 /* Table container ************/
table{
    width: 100%;
  border-collapse: collapse;
  table-layout: auto;
  font-family: Arial, sans-serif;
  font-size: 14px;
  background: #ffffff;
  border: 1px solid #d0d0d0;

  }

/* Optional heder alwayas fix on top and table scrolling  */
  table{
  overflow-x: auto;
  display: block;
  max-height: 750px; /* Optional scrolling */
  }

  /* Table border & cell style */
th {
   background: #01305c;
  color: #ffffff;
  padding: 10px;
  border: 1px solid #b5b5b5;
  text-align: left;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 1;
  white-space: nowrap;
  border-bottom:5px solid #dfc206;
  }
 td {
   padding: 8px 10px;
  border: 1px solid #e0e0e0;
  vertical-align: top;
  word-wrap: break-word; /* Wrap long text */
  white-space: normal;
  }
  /* Header design */
  tr:nth-child(even) {
  background-color: #f9f9f9;
}
  /* Row hover effect */
  tr:hover td {
   background: #fccc49;
 color: rgb(0, 15, 15);
  transition: background-color 1s ease, color 1s ease;
  }
</style>



  <body style=" margin: 0; display: flex;justify-content: center; align-items: center; background-color: rgb(9, 9, 9);">

  <div style="background-color: rgb(247, 249, 249); color: #004d80; font-weight: bold; border: 10px solid rgb(2, 85, 100); width: 10in; height: 18in; box-sizing: border-box; ">


  <div style="text-align:center; background-color: #920601; color: white; font-weight: bold;"> <strong>Imprest Voucher Data Entry</strong>  </div> 

  <br/>
  <div class="form-container">
  <h2 style="display:flex; justify-content:center;">Welcome, <span id="username"></span></h2>

  <!-- MAIN FORM -->
  <form id="mainAFICMForm">

  <input type="hidden" name="SNo" id="sNo">
  <input type="hidden" name="Timestamp" id="TimestampAFICM">

  <label for="vtype">Voucher Name:</label>
  <select id="vtype" name="vtype" style="background-color:#f8efed;" required></select>

  <label for="afi01">User Name:</label>
  <select id="afi01" name="Type" style="background-color:#f8efed;" required></select>

  <label">Select Transection Type*:</label>
  <select id="afi02" name="esmC"  style="background-color: #f0f6ed;"   required>
  <option value="PAYMENT">Payment</option>
  <option value="RECEIPT" style="color: rgb(243, 138, 138);">Receipt</option>
  </select>

  <label">Enter Date*:</label>
  <input type="date" id="afi03"  style="background-color: #f0f6ed;" name="esmD" required>


  <!-- Searchable Ledger Dropdown -->
    <div class="dropdownWrapper">
    <label">Search & Select Ledger*:</label>
    <input type="text" id="afi04" name="esmE" class="dropdownCLSearch" style="background-color: #f0f6ed;" required placeholder=" Search Ledger..." />
    <ul id="ledgerDropdown" class="dropdownList"></ul>
    </div>



  <label">Enter Amount*:</label>
  <input type="number" id="afi05" name="esmF" style="background-color: #f0f6ed;"  placeholder="Amount" required>

  <label">Enter Narration if any:</label>
  <input type="text" id="afi06" name="esmG" style="background-color: #f0f6ed;" placeholder="Narration">

  <input type="submit" id="submitAFICMButton" value="Submit">
  <button type="button" id="openMODIFYBtn" style="border: none; color: #012458; font-weight: bold;  cursor: pointer; background-color: #fafafa; font-weight: bold;"> Click to Modify</button>

  <br/><br/><br/>
  Fetched SR:
  <span id="fetchedSRNo"></span>
  <br/>

  <input type="button" id="deleteAFICMButton" value=" Delete" style="display:none; background:#dcfaf5;color:#5a0202; border: none; cursor: pointer; width: 2in;">
  <input type="button" id="newEntryAFICMButton"  value=" New Entry"  style="display:none; background:#dcfaf5; color:#004d12; border: none; cursor: pointer; width: 2in;">
  <strong id="waitAFIMessage" style="display:none;"></strong>
  </form>

  </div>

  <div id="search5792Bar" style="padding: 5px 10px;">

  <button id="refreshcmivTableBtn" style="border: none; color: rgb(252, 198, 196); font-weight: bold;  cursor: pointer; background: #424242;"> Refresh</button>
  <button onclick="printCUSERTable()" style="border: none; color: rgb(228, 252, 196); font-weight: bold;  cursor: pointer; background: #424242;"> Print Table</button>
  <input type="text" id="searchCLedger" style="width: 4in; border: #000 5px; cursor: pointer; border-radius: 4px;" placeholder=" Search in Table..." />

  </div>


  <!-- Table Output -->
  <div id="tableContainer" style="background-color: #fef8f6;"></div>

  <br/><br/>
  <span style="color:rgb(129, 1, 1);font-size:130%;font-family:Magneto;">eS |</span> 
  <span style="color:#004d80;font-size:130%;font-family:Magneto;">MTally</span>
 

  </div> 
  </body>

<!-- ==================  ledger dropdown with table and user voucher salection and user authrised section script start hare ============================ -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Imprest Voucher - MIPL</title>
</head>
</head>


  <style>
    .dropdownWrapper {
      position: relative;
      width: 300px;
      }

    .dropdownSearch {
      width: 100%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #a3a1a1;
      border-radius: 4px;
    }
    .dropdownList {
      list-style: none;
      border: 1px solid #ccc;
      max-height: 5000px;
      width: 3in;
      overflow-y: auto;
      margin: 0;
      padding: 0;
      display: none;
      background: white;
      position: absolute;
      width: 100%;
      z-index: 1000;
      border-radius: 0 0 4px 4px;
    }
    /* Style for the entire dropdown container */
    #ledgerDropdown.dropdownList {
    list-style-type: none;
    margin: 0;
    padding: 0;
    position: absolute;
    z-index: 999;
    width: 100%;
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #ccc;
    background-color: white;
    color: #000;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.15);
    font-size: 16px;
    border-radius: 4px;
    }

  /* Style for each dropdown item */
  #ledgerDropdown.dropdownList li {
    padding: 10px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s ease-in-out;
  }

  /* Highlight on hover */
  #ledgerDropdown.dropdownList li:hover {
    background-color: #007BFF;
    color: white;
   }

    /* Optional: remove border from last item */
    #ledgerDropdown.dropdownList li:last-child {
    border-bottom: none;
    }
    .positive {
      color: RED;
      font-weight: bold;
      }
  </style>
</head>

  <script>
  document.addEventListener("DOMContentLoaded", () => {

/* =====================================================
   ðŸ”‘ GOOGLE SHEET CONFIG
===================================================== */
const apiCLKey  = "AIzaSyBe-AlG9lpyXyC7KV-AavR6tbqOc75iYdM";
const sheetCLId = "1vjkI_bpHNR6Tna17FISridqXSvCUnELA5oMgnAqzbO0";

/* =====================================================
   MASTER DATA
===================================================== */
const voucherList = {
  CMVCR:{value:"CMVCR",text:"Cash User Voucher"},
  IVVCR:{value:"IVVCR",text:"Imprest Voucher (IV) Voucher"}
};

const cashVoucherUsers = {
  MA:{value:"MA",text:"MUKHTAR"},
  TA:{value:"TA",text:"TUSHAR"},
  JLN:{value:"JLN",text:"JOURNAL"},
  BANK:{value:"BANK",text:"BANK"},
  DB:{value:"DB",text:"DAYBOOK"}
};

const ivVoucherUsers = {
  IV01:{value:"IV01",text:"Amarbhadur"},
  IV02:{value:"IV02",text:"Vijender Sharma"},
  IV03:{value:"IV03",text:"Rahul Kumar"},
  IV04:{value:"IV04",text:"Raju"},
  IV05:{value:"IV05",text:"Mannu"},
  IV06:{value:"IV06",text:"Aakash"},
  IV07:{value:"IV07",text:"Manjeet"},
  IV08:{value:"IV08",text:"Nitin Kumar"},
  IV09:{value:"IV09",text:"Sunil Yadav"},
  IV10:{value:"IV10",text:"Ajay Kumar"},
  IV11:{value:"IV11",text:"Ravinder Kumar"},
  IV12:{value:"IV12",text:"Mahender"},
  IV13:{value:"IV13",text:"Suresh"}
};

const defaultSelections = {
  "Amarbhadur":{voucher:"IVVCR",user:"IV01"},
  "Vijender Sharma":{voucher:"IVVCR",user:"IV02"},
  "Mukhtar (Admin)":{voucher:"CMVCR",user:"MA"},
  "Nitin Kumar":{voucher:"IVVCR",user:"IV08"},
  "Rahul Kumar":{voucher:"IVVCR",user:"IV03"}
};

/* =====================================================
   ELEMENTS
===================================================== */
const voucherSel=document.getElementById("vtype");
const userSel=document.getElementById("afi01");
const usernameEl=document.getElementById("username");
const tableBox=document.getElementById("tableContainer");

/* =====================================================
   STATE
===================================================== */
let fullData=[];
let lastRenderedData=[];
let dataLoaded=false;

/* =====================================================
   UTIL
===================================================== */
function setSingleOption(sel,data){
  sel.innerHTML="";
  const o=document.createElement("option");
  o.value=data.value;
  o.textContent=data.text;
  sel.appendChild(o);
  sel.value=data.value;
}

/* =====================================================
   DEFAULT APPLY
===================================================== */
function applyDefaults(){
  const u=usernameEl.innerText.trim();
  if(!defaultSelections[u]) return false;

  const d=defaultSelections[u];
  setSingleOption(voucherSel,voucherList[d.voucher]);
  const src=d.voucher==="CMVCR"?cashVoucherUsers:ivVoucherUsers;
  setSingleOption(userSel,src[d.user]);
  handleSelection();
  return true;
}

const obs=new MutationObserver(()=>{
  if(applyDefaults()) obs.disconnect();
});
obs.observe(usernameEl,{childList:true,subtree:true});

/* =====================================================
   EVENTS
===================================================== */
voucherSel.onchange=handleSelection;
userSel.onchange=handleSelection;

/* =====================================================
   SHEET CONFIG
===================================================== */
function getSheetConfig(){
  if(voucherSel.value==="CMVCR")
    return {sheet:"FORMA",range:"A:G",mode:"FORMA"};
  if(voucherSel.value==="IVVCR")
    return {sheet:"IVCALC",range:"N:T",mode:"IV"};
  return null;
}

/* =====================================================
   SELECTION
===================================================== */
async function handleSelection(){
  tableBox.innerHTML="";
  dataLoaded=false;
  if(!voucherSel.value||!userSel.value) return;
  await loadSheetData();
}

/* =====================================================
   FETCH
===================================================== */
async function fetchSheetData(sheet,range){
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${sheetCLId}/values/${sheet}!${range}?key=${apiCLKey}`;
  const r=await fetch(url);
  const j=await r.json();
  return j.values||[];
}

/* =====================================================
   PROCESS
===================================================== */
function processRawData(rows,mode){
  if(mode==="IV"){
    return rows.slice(1)
      .filter(r=>!["JNP","JNR"].includes((r[4]||"").toUpperCase()))
      .map(r=>({
        tno:r[0]||"",
        type:r[1]||"",
        drcr:r[2]||"",
        dateStr:r[3]||"-",
        dateObj:parseIVDate(r[3]),
        ledger:r[4]||"",
        amount:Number(r[5])||0,
        narration:r[6]||"-"
      }));
  }
  return rows.slice(1).map(r=>({
    tno:r[0]||"",
    type:r[1]||"",
    drcr:r[2]||"",
    date:r[3]||"-",
    ledger:r[4]||"",
    amount:Number(r[5])||0,
    narration:r[6]||"-"
  }));
}

/* =====================================================
   LOAD
===================================================== */
async function loadSheetData(){
  tableBox.innerHTML="â³ Loading...";
  const cfg=getSheetConfig();
  const raw=await fetchSheetData(cfg.sheet,cfg.range);
  fullData=processRawData(raw,cfg.mode);
  dataLoaded=true;
  setupLedgerSearch();
  setupGlobalSearch();
  applyFilter();
}

/* =====================================================
   FILTER
===================================================== */
function applyFilter(){
  if(!dataLoaded) return;
  const u=userSel.value;
  lastRenderedData = u==="MA"
    ? fullData.filter(r=>r.type==="MA"||r.type==="JNP")
    : fullData.filter(r=>r.type===u);
  renderTable(lastRenderedData);
}

/* =====================================================
   RENDER
===================================================== */
function renderTable(data){
  if(!data.length){tableBox.innerHTML="No data";return;}
  const isIV=voucherSel.value==="IVVCR";
  let rows=[],bal=0;

  if(isIV){
    const asc=[...data].sort((a,b)=>a.dateObj-b.dateObj||(+a.tno||0)-(+b.tno||0));
    rows=asc.map(r=>{
      bal+=(r.drcr==="RECEIPT"?r.amount:-r.amount);
      return {...r,bal};
    }).reverse();
  }else{
    rows=[...data].sort((a,b)=>(+a.tno||0)-(+b.tno||0))
      .map(r=>{
        bal+=(r.drcr==="PAYMENT"?-1:1)*r.amount;
        return {...r,bal};
      }).reverse();
  }

  tableBox.innerHTML=`
  <table border="1" width="100%" cellpadding="6">
    <tr>
      <th>T.No</th><th>User</th><th>Type</th><th>Date</th>
      <th>Ledger</th><th>Narration</th><th>Amount</th><th>Balance</th>
    </tr>
    ${rows.map(r=>{
      let style="";
      if(r.drcr==="RECEIPT") style="color:red;font-weight:600";
      if(r.drcr==="BILL") style="color:blue;font-weight:600";
      if(r.drcr==="BILLDR") style="background:#eaeaea;color:green;font-weight:700";
      return`
      <tr style="${style}">
        <td>${r.tno}</td><td>${r.type}</td><td>${r.drcr}</td>
        <td>${isIV?r.dateStr:r.date}</td>
        <td>${r.ledger}</td><td>${r.narration}</td>
        <td>${r.amount}</td><td>${r.bal}</td>
      </tr>`;
    }).join("")}
  </table>`;
}

/* =====================================================
   DATE PARSER
===================================================== */
function parseIVDate(d){
  if(!d) return new Date(0);
  const [dd,mon,yy]=d.split("-");
  const m={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11};
  return new Date(+yy,m[mon],+dd);
}

/* =====================================================
   GLOBAL SEARCH
===================================================== */
function setupGlobalSearch(){
  const i=document.getElementById("searchCLedger");
  if(!i) return;
  i.oninput=()=>{
    const q=i.value.toLowerCase();
    renderTable(!q?lastRenderedData:
      lastRenderedData.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(q)))
    );
  };
}

/* =====================================================
   LEDGER DROPDOWN
===================================================== */
/* =====================================================
   ðŸ“’ LEDGER DROPDOWN (FIXED â€“ CREATE NEW ENABLED)
===================================================== */
let selectedLedger="";
function setupLedgerSearch(){
  const input=document.getElementById("afi04");
  const drop=document.getElementById("ledgerDropdown");
  if(!input||!drop) return;

  const ledgers=[...new Set(fullData.map(r=>r.ledger).filter(Boolean))];
  const lower=ledgers.map(l=>l.toLowerCase());

  input.oninput=()=>{
    drop.innerHTML="";
    selectedLedger="";
    const v=input.value.toLowerCase();
    if(!v) return drop.style.display="none";

    ledgers.filter(l=>l.toLowerCase().includes(v)).forEach(l=>{
      const li=document.createElement("li");
      li.textContent=l;
      li.onclick=()=>{selectedLedger=l;input.value=l;drop.style.display="none";};
      drop.appendChild(li);
    });

    const create=document.createElement("li");
    create.textContent="+ Create New";
    create.onclick=()=>{
      const val=prompt("Enter new ledger");
      if(!val||lower.includes(val.toLowerCase())) return;
      selectedLedger=val; input.value=val; drop.style.display="none";
    };
    drop.appendChild(create);
    drop.style.display="block";
  };

  document.addEventListener("click",e=>{
    if(!input.contains(e.target)&&!drop.contains(e.target)){
      drop.style.display="none";
      input.value=selectedLedger||"";
    }
  });
}
/* =====================================================
   ðŸ”„ REFRESH
===================================================== */
async function refreshcmivTableBtn(){
  if(!voucherSel.value || !userSel.value) return;
  await handleSelection();
}

document.getElementById("refreshcmivTableBtn")
  ?.addEventListener("click", refreshcmivTableBtn);

});
</script>

<!-- ==================  ledger dropdown with table and user voucher salection and user authrised section script stop hare ============================ -->


<!-- ==================  form submit with modify, new entry and delete option script start hare ============================ -->

<script>
document.addEventListener("DOMContentLoaded", () => {

  const scriptAFICMURL =
  "https://script.google.com/macros/s/AKfycbxQorut7S_GXoycQPFSbfU_-ZjCB7inC7I-VHhN5QmMiHcqIDhS9pvhCTUQJjueaw1L/exec";
  
  const formUser  = document.getElementById("afi01");   // USER
  const formVtype = document.getElementById("vtype");   // VOUCHER
  const tableContainer = document.getElementById("tableContainer"); // Table box

      /* ============================================
   ðŸ”  FORCE ALL TEXT INPUTS TO CAPITAL LETTER
   ============================================ */
function forceUppercase(form) {
  form.querySelectorAll("input[type='text'], textarea").forEach(el => {
    if (el.value) {
      el.value = el.value.toUpperCase().trim();
    }
  });
}
  /* =====================================================
     ðŸ“ FORM ELEMENTS
  ===================================================== */
  const mainForm  = document.getElementById("mainAFICMForm");
  const submitBtn = document.getElementById("submitAFICMButton");
  const deleteBtn = document.getElementById("deleteAFICMButton");
  const waitMsg   = document.getElementById("waitAFIMessage");
  const sNo = document.getElementById("sNo");
  const fetchedSRNo = document.getElementById("fetchedSRNo");
  const TimestampAFICM = document.getElementById("TimestampAFICM");
  const newEntryBtn = document.getElementById("newEntryAFICMButton");

  /* =====================================================
     âœï¸ MODIFY / FETCH
  ===================================================== */
  document.getElementById("openMODIFYBtn").onclick = async () => {
    if (!formUser.value || !formVtype.value) {
      alert("âŒ Please select USER and VOUCHER first");
      return;
    }

    const sr = prompt("Enter SR No");
    if (!sr) return;

    waitMsg.innerText = "Please wait, fetching data...";
    waitMsg.style.display = "block";

    try {
      const res = await fetch(`${scriptAFICMURL}?sNo=${sr}&vtype=${formVtype.value}`);
      const d = await res.json();

      if (d.result === "error") { alert("âŒ SR No not found"); return; }
      if (formUser.value !== d.Type) { alert("âŒ SR No does not match selected user"); return; }

      afi02.value = d.esmC || "";
      afi03.value = d.esmD || "";
      afi04.value = d.esmE || "";
      afi05.value = d.esmF || "";
      afi06.value = d.esmG || "";

      sNo.value = d.SNo;
      fetchedSRNo.textContent = d.SNo;

      deleteBtn.style.display = "inline-block";
      newEntryBtn.style.display = "inline-block";

      // âœ… ONLY TRIGGER
     document.getElementById("refreshcmivTableBtn")?.click();


    } catch (err) {
      alert("âŒ Fetch error");
    } finally {
      waitMsg.style.display = "none";
    }
  };

  /* =====================================================
     ðŸ—‘ DELETE ENTRY
  ===================================================== */
  deleteBtn.onclick = async () => {
    if (!sNo.value) { alert("âŒ No record selected"); return; }
    if (!confirm("You want to delete it?")) return;

    waitMsg.innerText = "Deleting...";
    waitMsg.style.display = "block";

    try {
      const res = await fetch(`${scriptAFICMURL}?action=delete&sNo=${sNo.value}&vtype=${formVtype.value}`);
      const r = await res.json();

      if (r.result === "success") {
        alert("âœ… Deleted successfully");
        mainForm.reset();
        fetchedSRNo.textContent = "";
        sNo.value = "";
        deleteBtn.style.display = "none";
        newEntryBtn.style.display = "none";

        // âœ… ONLY TRIGGER
       document.getElementById("refreshcmivTableBtn")?.click();


      } else {
        alert("âŒ Delete failed");
      }

    } catch (err) {
      alert("âŒ Delete error");
    } finally {
      waitMsg.style.display = "none";
    }
  };

  /* =====================================================
     ðŸš€ SUBMIT FORM
  ===================================================== */
  mainForm.onsubmit = async e => {
    e.preventDefault();

    forceUppercase(mainForm);   // âœ… ADD THIS LINE text in uppercase
    submitBtn.disabled = true;
    submitBtn.value = "Please wait...";
    waitMsg.innerText = "Submitting...";
    waitMsg.style.display = "block";

    TimestampAFICM.value = new Date().toLocaleString();

    try {
      const res = await fetch(scriptAFICMURL, {
        method: "POST",
        body: new FormData(mainForm)
      });

      const r = await res.json();

      if (r.result === "success") {
        alert("âœ… Saved successfully");
        mainForm.reset();
        fetchedSRNo.textContent = "";
        sNo.value = "";
        deleteBtn.style.display = "none";
        newEntryBtn.style.display = "none";

        // âœ… ONLY TRIGGER
        document.getElementById("refreshcmivTableBtn")?.click();


      } else {
        alert("âŒ Error while saving");
      }

    } catch (err) {
      alert("âŒ Submit error");
    } finally {
      submitBtn.disabled = false;
      submitBtn.value = "Submit";
      setTimeout(() => waitMsg.style.display = "none", 1200);
    }
  };

  /* =====================================================
     ðŸ†• NEW ENTRY
  ===================================================== */
  if (newEntryBtn) {
    newEntryBtn.onclick = () => {
      mainForm.reset();
      sNo.value = "";
      fetchedSRNo.textContent = "";
      deleteBtn.style.display = "none";
      newEntryBtn.style.display = "none";
      waitMsg.style.display = "none";

      // âœ… ONLY TRIGGER
      document.getElementById("refreshcmivTableBtn")?.click();


      console.log("ðŸ†• New Entry mode");
    };
  }

  /* =====================================================
     ðŸš€ INITIAL STATE
  ===================================================== */
  deleteBtn.style.display = "none";

});
</script>
<!-- ==================  form submit with modify, new entry and delete option script stop hare ============================ -->



<!-- ===================================  user login script start hare ============================ -->
<style>
/* ================= LOGIN POPUP ================= */
.login-modal {
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

/* LOGIN CARD */
.login-box {
  background: #ffffff;
  padding: 30px 25px;
  width: 340px;
  border-radius: 14px;
  text-align: center;
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  animation: slideUp 0.6s ease;
}

/* TITLE */
.login-box h3 {
  margin-bottom: 20px;
  font-size: 22px;
  color: #333;
}

/* INPUTS */
.login-box input {
  width: 100%;
  padding: 12px 14px;
  margin: 10px 0;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  outline: none;
  transition: 0.3s;
}

.login-box input:focus {
  border-color: #667eea;
  box-shadow: 0 0 0 2px rgba(102,126,234,0.2);
}

/* BUTTON */
.login-box button {
  width: 100%;
  padding: 12px;
  margin-top: 15px;
  border: none;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: #fff;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: 0.3s;
}

.login-box button:hover {
  opacity: 0.9;
  transform: translateY(-1px);
}

/* MESSAGE */
.login-msg {
  color: #e53935;
  margin-top: 12px;
  font-size: 13px;
}

/* ANIMATION */
@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(40px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ================= DASHBOARD ================= */
#dashboard {
  display: none;
  padding: 20px;
}

.hidden {
  display: none;
}

.button-div {
  display: none;
  margin-top: 10px;
}

</style>
</head>


<!-- ================= LOGIN POPUP ================= -->
<!-- ================= LOGIN POPUP ================= -->
<div id="loginModal" class="login-modal">
  <div class="login-box">

    <h3 style="color: rgb(2, 118, 196);">Welcome to Multitech Infracon Pvt. Ltd.</h3>
    <h3>User Login..</h3>

    <input type="text" id="user-id" placeholder="Enter User ID">
    <input type="password" id="password" placeholder="Enter Password">

    <button onclick="login()">Login</button>

    <p id="login-msg" class="login-msg"></p>
  </div>
</div>


<!-- ================= DASHBOARD ================= -->
<div id="dashboard">



 <div id="loginModal">
  <!-- login form -->
</div>

<div id="dashboard" style="display:none;">
  <!-- your app content -->
  <button onclick="logout()">Logout</button>
</div>

<p id="login-msg"></p>
</div>

<!-- ================= SCRIPT ================= -->
<script>
const apiKey = "AIzaSyBe-AlG9lpyXyC7KV-AavR6tbqOc75iYdM";
const sheetId = "1cXqnV7kKebvzk6-BAuuBNSmDnpJOyCqh7LRVB6sHiL4";
const range = 'USER!A:G';

let users = {};
let currentUser = "";

/* ===== Username helper ===== */
function setUsernameDisplays(name) {
  document.querySelectorAll('#username').forEach(el => {
    el.innerText = name || "";
  });
}

function clearUsernameDisplays() {
  document.querySelectorAll('#username').forEach(el => {
    el.innerText = "";
  });
}

/* ===== Fetch User Data ===== */
async function fetchUserData() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
  const response = await fetch(url);
  const data = await response.json();
  const rows = data.values || [];

  users = {};
  for (let i = 1; i < rows.length; i++) {
    const [enabled, userId, password, status, displayName] = rows[i];
    if (enabled === "1") {
      users[userId] = {
        password,
        displayName,
        status: status?.toLowerCase() || "unlocked"
      };
    }
  }
}

/* ===== Login ===== */
function login() {
  const userId = document.getElementById('user-id').value.trim();
  const password = document.getElementById('password').value;
  const msg = document.getElementById('login-msg');

  if (!users[userId]) {
    msg.innerText = "Invalid User ID or Password!";
    return;
  }

  const user = users[userId];

  if (user.status === "locked") {
    msg.innerText = "Your account is locked!";
    return;
  }

  const expiryDate = Date.parse(user.status);
  if (!isNaN(expiryDate)) {
    const diffDays = Math.ceil((expiryDate - new Date()) / 86400000);
    if (diffDays < 0) {
      msg.innerText = "Your Licence Expired, Please Contact Admin";
      return;
    } else if (diffDays <= 5) {
      alert(`Your licence will expire in ${diffDays} day(s)`);
    }
  }

  if (user.password !== password) {
    msg.innerText = "Invalid User ID or Password!";
    return;
  }

  /* ===== SUCCESS LOGIN ===== */
  currentUser = userId;

  document.getElementById('loginModal').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  setUsernameDisplays(user.displayName);

  msg.innerText = "";
  document.getElementById('user-id').value = "";
  document.getElementById('password').value = "";
}

/* ===== Logout ===== */
function logout() {
  currentUser = "";
  clearUsernameDisplays();
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginModal').style.display = 'flex';
}

/* ===== On Load ===== */
window.onload = async () => {
  await fetchUserData();
  document.getElementById('loginModal').style.display = 'flex';
};
</script>

<!-- ===================================  user login script stop hare ============================ -->
